version: "3"
services:
  db:
    image: postgres:latest
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./barman/init-barman-users.sh:/docker-entrypoint-initdb.d/init-barman-users.sh
    container_name: psql
    environment:
      - POSTGRES_USER=pdfbuilder
      - POSTGRES_PASSWORD=FKQMoXB7BQyU1zp59DGu
      - POSTGRES_DB=pdfbuilder
    stdin_open: true
    tty: true
    command:
      - -c
      - wal_level=replica
      - -c
      - max_wal_senders=10
      - -c
      - max_replication_slots=10
      - -c
      - hot_standby=on
      - -c
      - ssl=off
    
  polr:
    image: wedi42/polr
    container_name: polr
    ports:
      - "5004:80"
    environment:
      - DB_HOST=mysql
      - DB_DATABASE=polr
      - DB_USERNAME=polr
      - DB_PASSWORD=FKQMoXB7BQyU1zp59DGu
      - ADMIN_USERNAME=polradmin
      - ADMIN_PASSWORD=FKQMoXB7BQyU1zp59DGu
      - ADMIN_EMAIL=kamaldeep.kaur@aurigait.com
    depends_on:
      - mysql

  mysql:
    image: mysql
    container_name: mysql
    restart: always
    ports:
      - "3306:3306"
    expose:
      - "3306"
    environment:
      - MYSQL_ROOT_PASSWORD=FKQMoXB7BQyU1zp59DGu
      - MYSQL_DATABASE=polr
      - MYSQL_USER=polr
      - MYSQL_PASSWORD=FKQMoXB7BQyU1zp59DGu
    volumes:
      - mysql-data:/var/lib/mysql
  pdf-builder:
    image: &pdf-builder pdf-builder
    build: ./src
    #command: "python3 -m pdfbase.main"
    volumes:
      - ./src/:/usr/src/
    depends_on:
      - db

  plugin:
    image: *pdf-builder
    build: ./src
    command: "python3 -m plugin.odk_plugin.server run"
    ports:
      - "5000:5000"
    volumes:
      - ./src/:/usr/src/
    depends_on:
      - db
  kafka-consumer:
    image: *pdf-builder
    build: ./src
    restart: always
    command: "python3 -m pdfbase.data_consumer"
    volumes:
      - ./src/:/usr/src/
    depends_on:
      - db
  delete-drive:
    image: *pdf-builder
    build: ./src
    restart: always
    command: "crond -f -d 8"
    volumes:
      - ./src/:/usr/src/
    depends_on:
      - db
  graphql-engine:
    image: hasura/graphql-engine:v1.1.1
    ports:
      - "5001:8080"
    depends_on:
      - db
    restart: always
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://pdfbuilder:FKQMoXB7BQyU1zp59DGu@db:5432/pdfbuilder
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true" # set to "false" to disable console
      HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
      HASURA_GRAPHQL_ADMIN_SECRET: 2OWslm5aAjlTARU
  barman:
    image: decsis/pg-barman
    environment:
      BARMAN_LOG_LEVEL: WARNING
    volumes:
      - ./barman/db.conf:/etc/barman.d/db.conf
      - /var/www/html/barmanbackup/:/var/lib/barman/
    ports:
      - 8000:8000/tcp
volumes:
  db-data:
  mysql-data: